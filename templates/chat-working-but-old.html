<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        #chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            background-color: #ffffff;
        }

        #message-form {
            display: flex;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #send-button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #send-button:hover {
            background-color: #0056b3;
        }

        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #username-form {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #profile-pic {
            margin-top: 10px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .message img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #007BFF;
        }

        .message-content {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 70%;
        }

        .message-content strong {
            display: block;
            margin-bottom: 5px;
            color: #007BFF;
        }

        #logout-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        #logout-button:hover {
            background-color: #e60000;
        }

        #change-pfp-button {
            position: absolute;
            top: 10px;
            right: 100px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        #change-pfp-button:hover {
            background-color: #218838;
        }

        #settings-button {
            position: absolute;
            top: 10px;
            right: 290px;
            background-color: #ffc107;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        #settings-button:hover {
            background-color: #e0a800;
        }

        
    /* GIF Modal */
    #gif-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    #gif-modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #gif-search-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    #gif-results {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        max-height: 300px;
        overflow-y: auto;
    }

    #gif-results img {
        width: 100px;
        height: 100px;
        cursor: pointer;
        border-radius: 5px;
        transition: transform 0.2s;
    }

    #gif-results img:hover {
        transform: scale(1.1);
    }

    #close-gif-modal {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    #close-gif-modal:hover {
        background-color: #0056b3;
    }

    /* Reaction Buttons */
    .react-button, .edit-button, .delete-button {
        margin-left: 10px;
        padding: 5px 10px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }

    .react-button:hover {
        background-color: #ffc107;
    }

    .edit-button:hover {
        background-color: #5a6268;
    }

    .delete-button:hover {
        background-color: #dc3545;
    }

    /* Typing Indicator */
    #typing-indicator {
        font-style: italic;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Dark Mode */
    body.dark-mode {
        background-color: #1e1e1e;
        color: #fff;
    }

    body.dark-mode .message-content {
        background-color: #444;
        color: #fff;
    }

    /* Custom Themes */
    #theme-button {
        position: absolute;
        top: 10px;
        right: 535px;
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
    }

    #theme-button:hover {
        background-color: #138496;
    }

    /* Private Messaging */
    #private-chat-button {
        position: absolute;
        top: 10px;
        right: 390px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
    }

    #private-chat-button:hover {
        background-color: #5a6268;
    }

    /* Mini-Games */
    #game-button {
        position: absolute;
        top: 10px;
        right: 680px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
    }

    #game-button:hover {
        background-color: #218838;
    }
</style>
</head>
<body>
    <div id="username-modal">
        <form id="username-form">
            <h2>Enter a Username</h2>
            <input type="text" id="username" placeholder="Username" required>
            <input type="file" id="profile-pic" accept="image/*">
            <button type="submit">Join Chat</button>
        </form>
    </div>

    <div id="chat-container">
        <button id="logout-button">Logout</button>
        <button id="change-pfp-button">Change Profile Picture</button>
        <button id="settings-button">Settings</button>
        <div id="messages"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type a message or paste an image..." required>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            <button type="button" id="upload-button">ðŸ“·</button>
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>

    <div id="online-users-bar" style="position: fixed; top: 46.2px; right: 0; width: 200px; height: 86.67%; background-color: #f1f1f1; border-left: 1px solid #ccc; overflow-y: auto; padding: 10px;">
        <h3>Online Users</h3>
        <ul id="online-users-list" style="list-style: none; padding: 0; margin: 0;">
            <!-- Online users will be dynamically added here -->
        </ul>
    </div>

    <script>
        const onlineUsersList = document.getElementById('online-users-list');

        function fetchOnlineUsers() {
            fetch('/get-online-users')
                .then((response) => response.json())
                .then((users) => {
                    onlineUsersList.innerHTML = ''; // Clear the list
                    users.forEach((user) => {
                        const userItem = document.createElement('li');
                        userItem.textContent = user.username;
                        userItem.style.marginBottom = '10px';
                        onlineUsersList.appendChild(userItem);
                    });
                })
                .catch((error) => console.error('Error fetching online users:', error));
        }

        function markUserOnline(username) {
            fetch('/mark-online', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username }),
            }).catch((error) => console.error('Error marking user online:', error));
        }

        function markUserOffline(username) {
            fetch('/mark-offline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username }),
            }).catch((error) => console.error('Error marking user offline:', error));
        }

        

        // Mark the user offline when they leave
        window.addEventListener('beforeunload', () => {
            if (username) {
                markUserOffline(username);
            }
        });

        // Poll for online users every 10 seconds
        setInterval(fetchOnlineUsers, 5000);
        fetchOnlineUsers(); // Initial fetch
    </script>

    <button id="private-chat-button">PRIVATE CHAT</button>
    <button id="theme-button">Change Theme</button>
    <button id="game-button">Play Rock-Paper-Scissors</button>
    <button id="code-button">Play Rock-Paper-Scissors</button>

    
    <script>
        const usernameModal = document.getElementById('username-modal');
const usernameForm = document.getElementById('username-form');
const chatContainer = document.getElementById('chat-container');
const messagesDiv = document.getElementById('messages');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const imageUpload = document.getElementById('image-upload');
const uploadButton = document.getElementById('upload-button');
let username = '';
let profilePic = '';
let lastMessageId = -1; // Initialize to -1 to fetch all messages on first load

// Add GIF support using Giphy API with a modal
const gifButton = document.createElement('button');
gifButton.textContent = 'GIF';
gifButton.type = 'button'; // Ensure this button does not act as a submit button
gifButton.style.marginRight = '10px';
gifButton.addEventListener('click', () => {
    const gifModal = document.createElement('div');
    gifModal.id = 'gif-modal';
    gifModal.innerHTML = `
        <div id="gif-modal-content">
            <h2>Search for a GIF</h2>
            <input type="text" id="gif-search-input" placeholder="Type to search...">
            <div id="gif-results"></div>
            <button id="close-gif-modal">Close</button>
        </div>
    `;
    document.body.appendChild(gifModal);

    const gifSearchInput = document.getElementById('gif-search-input');
    const gifResults = document.getElementById('gif-results');
    const closeGifModal = document.getElementById('close-gif-modal');

    gifSearchInput.addEventListener('input', () => {
        const query = gifSearchInput.value.trim();
        if (query) {
            fetch(`https://api.giphy.com/v1/gifs/search?api_key=SzAhImfXJkuLaI0OXFUR7B0hrFo3LLBT&q=${query}&limit=10`)
                .then((response) => response.json())
                .then((data) => {
                    gifResults.innerHTML = '';
                    data.data.forEach((gif) => {
                        const gifImg = document.createElement('img');
                        gifImg.src = gif.images.fixed_height.url;
                        gifImg.addEventListener('click', () => {
                            const messageData = { username, profilePic, message: '', image: gif.images.fixed_height.url };
                            fetch('/send-message', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(messageData),
                            }).then(() => {
                                document.body.removeChild(gifModal); // Close the modal after selecting a GIF
                            });
                        });
                        gifResults.appendChild(gifImg);
                    });
                });
        } else {
            gifResults.innerHTML = '';
        }
    });

    closeGifModal.addEventListener('click', () => {
        document.body.removeChild(gifModal);
    });
});

messageForm.insertBefore(gifButton, messageInput);

    // Handle reaction button click
messagesDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('react-button')) {
        const messageId = e.target.dataset.messageId;
        const reaction = prompt('React with an emoji:');
        if (reaction) {
            fetch('/add-reaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: messageId, reaction }),
            }).then(() => {
                const reactionElement = document.createElement('span');
                reactionElement.textContent = reaction;
                e.target.parentElement.appendChild(reactionElement);
            });
        }
    }
});

// Handle edit button click
messagesDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('edit-button')) {
        const messageId = e.target.dataset.messageId;
        const newMessage = prompt('Edit your message:');
        if (newMessage) {
            fetch('/edit-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: messageId, message: newMessage }),
            }).then(() => fetchNewMessages());
        }
    }
});

// Handle delete button click
messagesDiv.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-button')) {
        const messageId = e.target.dataset.messageId;
        if (confirm('Are you sure you want to delete this message?')) {
            fetch('/delete-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: messageId }),
            }).then(() => fetchNewMessages());
        }
    }
});

        // Add reactions to messages
        messagesDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('react-button')) {
            const messageId = e.target.dataset.messageId;
            const reaction = prompt('React with an emoji:');
            if (reaction) {
                fetch('/add-reaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: messageId, reaction }),
                }).then(() => {
                    const reactionElement = document.createElement('span');
                    reactionElement.textContent = reaction;
                    e.target.parentElement.appendChild(reactionElement);
                });
            }
        }
    });
    

    // Handle edit button click
    messagesDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-button')) {
            const messageId = e.target.dataset.messageId;
            const newMessage = prompt('Edit your message:');
            if (newMessage) {
                fetch('/edit-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: messageId, message: newMessage }),
                }).then(() => fetchNewMessages());
            }
        }
    });

    // Handle delete button click
    messagesDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-button')) {
            const messageId = e.target.dataset.messageId;
            if (confirm('Are you sure you want to delete this message?')) {
                fetch('/delete-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: messageId }),
                }).then(() => fetchNewMessages());
            }
        }
    });

    // Handle private chat button click
    document.getElementById('private-chat-button').addEventListener('click', () => {
        window.location.href = '/private';
    });

    // Long polling for private messages
    function pollPrivateMessages() {
        fetch(`/poll-private-messages?last_id=${lastMessageId}`)
            .then((response) => response.json())
            .then((messages) => {
                messages.forEach((message) => {
                    appendMessage(message);
                    lastMessageId = Math.max(lastMessageId, message.id);
                });
                pollPrivateMessages(); // Continue polling after receiving a response
            })
            .catch((error) => {
                console.error('Error polling private messages:', error);
                setTimeout(pollPrivateMessages, 5000); // Retry after 5 seconds on error
            });
    }

    // Append a message to the chat
    function appendMessage({ id, username, profilePic, message, image }) {
    console.log('Appending message:', { id, username, profilePic, message, image }); // Debugging log

    // Check if the message already exists in the DOM
    if (document.querySelector(`.message[data-id="${id}"]`)) return;

    // Create the message container
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.dataset.id = id;

    // Add the profile picture, username, and message content
    const imageTag = image
        ? `<img src="${image}" alt="Uploaded Image" style="width: 400px; height: auto; margin-top: 10px; border-radius: 0; border: none;">`
        : '';

    messageElement.innerHTML = `
        <img src="${profilePic || 'https://via.placeholder.com/50'}" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
        <div class="message-content" style="display: inline-block; vertical-align: top;">
            <strong>${username}</strong>
            <p>${message}</p>
            ${imageTag}
        </div>
    `;

    // Add the buttons (React, Edit, Delete)
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '10px';

    const reactButton = document.createElement('button');
    reactButton.textContent = 'React';
    reactButton.classList.add('react-button');
    reactButton.dataset.messageId = id;

    const editButton = document.createElement('button');
    editButton.textContent = 'Edit';
    editButton.classList.add('edit-button');
    editButton.dataset.messageId = id;

    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete';
    deleteButton.classList.add('delete-button');
    deleteButton.dataset.messageId = id;

    buttonContainer.appendChild(reactButton);
    buttonContainer.appendChild(editButton);
    buttonContainer.appendChild(deleteButton);

    messageElement.appendChild(buttonContainer);

    // Append the message to the messages container
    messagesDiv.appendChild(messageElement);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

    // Fetch private messages when on the private chat page
    if (window.location.pathname === '/private') {
        pollPrivateMessages();
    }

    // Add typing indicator
    let typingTimeout;
    messageInput.addEventListener('input', () => {
        clearTimeout(typingTimeout);
        fetch('/typing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });
        typingTimeout = setTimeout(() => {
            fetch('/stop-typing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
        }, 2000);
    });

    /* Add dark mode toggle
    const darkModeToggle = document.createElement('button');
    darkModeToggle.textContent = 'Dark Mode';
    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });
    document.body.appendChild(darkModeToggle);
*/
    // Add custom themes
    const themeButton = document.getElementById('theme-button');
    themeButton.textContent = 'Change Theme';
    themeButton.addEventListener('click', () => {
        const themeColor = prompt('Enter a theme color (e.g., #ff0000):');
        if (themeColor) {
            document.body.style.backgroundColor = themeColor;
            localStorage.setItem('themeColor', themeColor);
        }
    });
    document.body.appendChild(themeButton);

    /* Add Rock-Paper-Scissors game
    const gameButton = document.createElement('button');
    gameButton.textContent = 'Play Rock-Paper-Scissors';
    gameButton.addEventListener('click', () => {
        const choices = ['Rock', 'Paper', 'Scissors'];
        const userChoice = prompt('Choose Rock, Paper, or Scissors:');
        const computerChoice = choices[Math.floor(Math.random() * choices.length)];
        if (userChoice) {
            alert(`You chose ${userChoice}, Computer chose ${computerChoice}`);
        }
    });
    document.body.appendChild(gameButton);
    */
    // Multiplayer Rock-Paper-Scissors game
    const gameButton = document.getElementById('game-button');
    gameButton.textContent = 'Play Rock-Paper-Scissors';
    document.body.appendChild(gameButton);

    let waitingForPlayer = false;
    let opponent = null;

    gameButton.addEventListener('click', () => {
        if (!waitingForPlayer) {
            const userChoice = prompt('Choose Rock, Paper, or Scissors:').toLowerCase();
            const choices = ['rock', 'paper', 'scissors'];
            if (!choices.includes(userChoice)) {
                alert('Not a valid choice');
            } else {
                waitingForPlayer = true;
                gameButton.textContent = 'Waiting for another player...';

                // Notify the server that this user is ready to play
                fetch('/start-game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username }),
                }).then(() => {
                    // Poll the server to check if another player has joined
                    const checkForOpponent = setInterval(() => {
                        fetch('/check-opponent')
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.opponent) {
                                    clearInterval(checkForOpponent);
                                    opponent = data.opponent;
                                    waitingForPlayer = false;
                                    gameButton.textContent = `Playing against ${opponent}`;
                                    startGame(userChoice);
                                }
                            });
                    }, 2000);
                });
            }
        }
    });

    function startGame(userChoice) {
        fetch('/play-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, choice: userChoice }),
        })
            .then((response) => response.json())
            .then((result) => {
                alert(`You chose ${userChoice}, ${opponent} chose ${result.opponentChoice}. ${result.result}`);
                gameButton.textContent = 'Play Rock-Paper-Scissors';
            });
    }

function fetchAllMessages() {
    console.log("Fetching all messages");
    fetch('/get-messages')
        .then((response) => response.json())
        .then((allMessages) => {
            console.log('Fetched messages:', allMessages); // Debugging log
            messagesDiv.innerHTML = ''; // Clear the chat only when fetching all messages
            allMessages.forEach((message) => {
                appendMessage(message);
                lastMessageId = Math.max(lastMessageId, message.id); // Update lastMessageId
            });
        });
}

// Handle username form submission
usernameForm.addEventListener('submit', (e) => {
    e.preventDefault();
    username = document.getElementById('username').value;
    const fileInput = document.getElementById('profile-pic');
    if (fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = () => {
            profilePic = reader.result;
            usernameModal.style.display = 'none';
            chatContainer.style.display = 'flex';
            fetchAllMessages(); // Fetch all messages when the user joins
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        profilePic = '';
        usernameModal.style.display = 'none';
        chatContainer.style.display = 'flex';
        fetchAllMessages(); // Fetch all messages when the user joins
    }
});

// Save user data to localStorage
function saveUserData() {
    const userData = { username, profilePic };
    localStorage.setItem('chatUserData', JSON.stringify(userData));
}

// Load user data from localStorage
function loadUserData() {
    const userData = localStorage.getItem('chatUserData');
    if (userData) {
        const { username: savedUsername, profilePic: savedProfilePic } = JSON.parse(userData);
        username = savedUsername;
        profilePic = savedProfilePic;
        usernameModal.style.display = 'none';
        chatContainer.style.display = 'flex';
        fetchAllMessages(); // Fetch all messages when user data is loaded
    }
}

// Long polling for new messages
function pollMessages() {
    console.log('Polling messages');
        fetch(`/poll-messages?last_id=${lastMessageId}`)
            .then((response) => response.json())
            .then((messages) => {
                messages.forEach((message) => {
                    appendMessage(message);
                    lastMessageId = Math.max(lastMessageId, message.id);
                });
                pollMessages(); // Continue polling after receiving a response
            })
            .catch((error) => {
                console.error('Error polling messages:', error);
                setTimeout(pollMessages, 5000); // Retry after 5 seconds on error
            });
    }


// Handle background image upload
function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                const backgroundImage = reader.result;
                document.body.style.backgroundImage = `url(${backgroundImage})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundRepeat = 'no-repeat';
                localStorage.setItem('backgroundImage', backgroundImage); // Save background image to localStorage
            };
            reader.readAsDataURL(file);
        }
    }

// Call loadUserData on page load
window.addEventListener('DOMContentLoaded', () => {
    loadUserData();
    if (username) {
        markUserOnline(username);
    }
});


window.addEventListener('DOMContentLoaded', () => {
    // Start fetching messages
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
        document.body.style.backgroundColor = '#333';
        document.body.style.color = '#fff';
        document.querySelectorAll('*').forEach((element) => {
            if (!['BUTTON', 'INPUT', 'TEXTAREA'].includes(element.tagName)) {
                element.style.backgroundColor = '#333';
                element.style.color = '#fff';
            }
        });
    }
    console.log("Running fetchAllMessages");
    fetchAllMessages();
    console.log("Running pollMessages");
    pollMessages(); // Start long polling

    
});


// Save user data when username form is submitted
usernameForm.addEventListener('submit', () => {
    saveUserData();
});

// Handle message form submission
messageForm.addEventListener('submit', (e) => {
    e.preventDefault(); // Prevent the form from submitting normally
    const message = messageInput.value.trim();
    if (message) {
        const messageData = { username, profilePic, message };
        fetch('/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(messageData),
        }).then(() => {
            messageInput.value = ''; // Clear the input box after sending
        });
    }
});



// Handle image upload button click
uploadButton.addEventListener('click', () => {
    imageUpload.click(); // Trigger the hidden file input
});

// Handle pasting an image into the text box
messageInput.addEventListener('paste', (event) => {
    const items = event.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
            const file = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = () => {
                const imageData = reader.result;
                const messageData = { username, profilePic, message: '', image: imageData };
                sendMessageToServer(messageData); // Send the base64 image data as a message to the server
            };
            reader.readAsDataURL(file);
            event.preventDefault(); // Prevent the default paste behavior
            break;
        }
    }
});

// Open image in a new tab when clicked
messagesDiv.addEventListener('click', (e) => {
    if (e.target.tagName === 'IMG' && e.target.alt === 'Uploaded Image') {
        const imageUrl = e.target.getAttribute('src');
        if (imageUrl.startsWith('data:image/')) {
            const newTab = window.open();
            newTab.document.body.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: auto;">`;
        } else {
            window.open(imageUrl, '_blank');
        }
    }
});

// Handle image file selection
imageUpload.addEventListener('change', () => {
    const file = imageUpload.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = () => {
            const imageData = reader.result;
            const messageData = { username, profilePic, message: '', image: imageData };
            sendMessageToServer(messageData); // Send the image as a message to the server
        };
        reader.readAsDataURL(file);
    }
});

// Handle logout button click
document.getElementById('logout-button').addEventListener('click', () => {
    localStorage.removeItem('chatUserData'); // Clear user data from localStorage
    username = '';
    profilePic = '';
    chatContainer.style.display = 'none';
    usernameModal.style.display = 'flex'; // Show the username modal again
});

// Handle settings button click
document.getElementById('settings-button').addEventListener('click', () => {
    const settingsModal = document.createElement('div');
    settingsModal.style.position = 'fixed';
    settingsModal.style.top = '0';
    settingsModal.style.left = '0';
    settingsModal.style.width = '100%';
    settingsModal.style.height = '100%';
    settingsModal.style.background = 'rgba(0, 0, 0, 0.5)';
    settingsModal.style.display = 'flex';
    settingsModal.style.justifyContent = 'center';
    settingsModal.style.alignItems = 'center';
    settingsModal.style.zIndex = '1000';

    settingsModal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 5px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2>Settings</h2>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox" id="dark-mode-toggle">
                Enable Dark Mode
            </label>
            <button id="close-settings" style="margin-top: 10px; padding: 10px 20px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>
        </div>
    `;

    document.body.appendChild(settingsModal);



    // Load dark mode setting from localStorage
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    darkModeToggle.checked = isDarkMode;
    if (isDarkMode) {
        document.body.style.backgroundColor = '#1e1e1e'; // Slightly lighter dark color
            document.body.style.color = '#fff';
            document.querySelectorAll('*').forEach((element) => {
                if (!['BUTTON', 'INPUT', 'TEXTAREA'].includes(element.tagName)) {
                    element.style.backgroundColor = '#1e1e1e';
                    element.style.color = '#fff';
                }
            });
        document.querySelectorAll('.message-content').forEach((message) => {
            message.style.backgroundColor = '#444';
            message.style.color = '#fff';
        });
    }

    // Update all messages when dark mode is toggled
    darkModeToggle.addEventListener('change', () => {
        if (darkModeToggle.checked) {
            document.body.style.backgroundColor = '#333';
            document.body.style.color = '#fff';
            document.querySelectorAll('.message-content').forEach((message) => {
                message.style.backgroundColor = '#444';
                message.style.color = '#fff';
            });
            localStorage.setItem('darkMode', 'true');
        } else {
            document.body.style.backgroundColor = '#f9f9f9';
            document.body.style.color = '#000';
            document.querySelectorAll('.message-content').forEach((message) => {
                message.style.backgroundColor = '#f1f1f1';
                message.style.color = '#000';
            });
            localStorage.setItem('darkMode', 'false');
        }
    });

    

    // Load background image from localStorage on page load
    const savedBackgroundImage = localStorage.getItem('backgroundImage');
    if (savedBackgroundImage) {
        document.body.style.backgroundImage = `url(${savedBackgroundImage})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundRepeat = 'no-repeat';
    }

    // Request notification permission
    if (Notification.permission !== 'granted') {
        Notification.requestPermission();
    }

    // Show browser notification for new messages
    function showNotification({ username, message, image }) {
        console.log('Showing notification');
    if (Notification.permission === 'granted') {
        const options = {
            body: message || 'New image received',
            icon: image || 'https://i0.wp.com/catcaresolutions.com/wp-content/uploads/2019/07/funny-wet-cat.jpg?resize=626%2C710&ssl=1', // Default icon if no image
        };
        new Notification(`New message from ${username}`, options);
    }
}

// Request notification permission on page load
if (Notification.permission !== 'granted') {
    Notification.requestPermission();
}


/*    // Modify fetchNewMessages to include notifications
function fetchNewMessages() {
        fetch(`/get-messages?last_id=${lastMessageId}`)
            .then((response) => response.json())
            .then((newMessages) => {
                newMessages.forEach((message) => {
                    appendMessage(message);
                    showNotification(message); // Show notification for each new message
                    lastMessageId = message.id; // Update lastMessageId to the latest message ID
                });
            });
    }
*/
    

    // Handle dark mode toggle
    darkModeToggle.addEventListener('change', () => {
        if (darkModeToggle.checked) {
            document.body.style.backgroundColor = '#1e1e1e'; // Slightly lighter dark color
            document.body.style.color = '#fff';
            document.querySelectorAll('*').forEach((element) => {
                if (!['BUTTON', 'INPUT', 'TEXTAREA'].includes(element.tagName)) {
                    element.style.backgroundColor = '#1e1e1e';
                    element.style.color = '#fff';
                }
            });
            localStorage.setItem('darkMode', 'true');
        } else {
            document.body.style.backgroundColor = '#f9f9f9';
            document.body.style.color = '#000';
            document.querySelectorAll('*').forEach((element) => {
                element.style.backgroundColor = '';
                element.style.color = '';
            });
            localStorage.setItem('darkMode', 'false');
        }
    });

    // Close settings modal
    document.getElementById('close-settings').addEventListener('click', () => {
        document.body.removeChild(settingsModal);
    });
});

// Handle change profile picture button click
document.getElementById('change-pfp-button').addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                profilePic = reader.result;
                saveUserData(); // Save the updated profile picture
                alert('Profile picture updated successfully!');
            };
            reader.readAsDataURL(file);
        }
    });
    fileInput.click(); // Trigger the file input dialog
});

// Append a message to the chat
function appendMessage({ id, username, profilePic, message, image }) {
    // Check if the message already exists in the chat
    if (document.querySelector(`.message[data-id="${id}"]`)) {
        return; // Skip if the message already exists
    }

    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.setAttribute('data-id', id); // Add a unique identifier to prevent duplication

    const imageTag = image
        ? `<img src="${image}" alt="Uploaded Image" style="width: 400px; height: auto; margin-top: 10px; border-radius: 0; border: none;">`
        : '';

    messageElement.innerHTML = `
        <img src="${profilePic || 'https://i0.wp.com/catcaresolutions.com/wp-content/uploads/2019/07/funny-wet-cat.jpg?resize=626%2C710&ssl=1'}" alt="Profile Picture">
        <div class="message-content">
            <strong>${username}</strong>
            ${message}
            ${imageTag}
        </div>
    `;

    // Apply dark mode styles if enabled
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
        console.log('Dark mode enabled');
        const messageContent = messageElement.querySelector('.message-content');
        messageContent.style.backgroundColor = '#444';
        messageContent.style.color = '#fff';
    }

    messagesDiv.appendChild(messageElement);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Fetch only new messages

let isFetching = false; // Prevent concurrent fetches

function fetchNewMessages() {
    if (isFetching) return; // Skip if a fetch is already in progress
    isFetching = true;

    fetch(`/get-messages?last_id=${lastMessageId}`)
        .then((response) => response.json())
        .then((newMessages) => {
            newMessages.forEach((message) => {
                appendMessage(message);
                lastMessageId = Math.max(lastMessageId, message.id); // Update lastMessageId
            });
        })
        .finally(() => {
            isFetching = false; // Reset the fetching flag
        });
}

/*
// Periodically refresh the page
setInterval(() => {
    location.reload();
}, 120000); // Refresh the page every 2 minutes
*/

// Send a message to the server
function sendMessageToServer(messageData) {
    fetch('/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(messageData),
    }).then((response) => {
        if (response.ok) {
            fetchNewMessages(); // Fetch new messages after sending
        }
    });
}



    </script>
</body>
    <script>
        document.getElementById('private-chat-button').addEventListener('click', () => {
            window.location.href = '/private';
        });
    </script>
    

    
</body>
</html>