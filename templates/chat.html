<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        #chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        #top-buttons {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #007BFF;
            color: white;
        }

        #top-buttons button {
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        #top-buttons button:hover {
            background-color: #003f7f;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            background-color: #ffffff;
        }

        #message-form {
            display: flex;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #send-button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #send-button:hover {
            background-color: #0056b3;
        }

        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #username-form {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #profile-pic {
            margin-top: 10px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .message img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #007BFF;
        }

        .message-content {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 70%;
        }

        .message-content strong {
            display: block;
            margin-bottom: 5px;
            color: #007BFF;
        }

        #online-users-bar {
            position: fixed;
            top: 57px;
            right: 0;
            width: 200px;
            height: calc(100% - 138px);
            background-color: #f1f1f1;
            border-left: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
        }

        #online-users-bar h3 {
            margin: 0 0 10px;
        }

        #online-users-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #online-users-list li {
            margin-bottom: 10px;
        }

        #settings-modal {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        #settings-modal div {
            background: #ffffff;
            color: #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #settings-modal button {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ccc;
        }

        #settings-modal button:hover {
            background-color: #e0e0e0;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode #settings-modal {
            background: rgba(0, 0, 0, 0.8);
            color: #e0e0e0;
        }

        body.dark-mode #settings-modal div {
            background: #2a2a2a;
            color: #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode #settings-modal button {
            background-color: #444;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode #settings-modal button:hover {
            background-color: #555;
        }

        body.dark-mode #top-buttons {
            background-color: #1f1f1f;
        }

        body.dark-mode #messages {
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }

        body.dark-mode #message-form {
            background-color: #1f1f1f;
            border-top: 1px solid #333;
        }

        body.dark-mode #message-input {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        body.dark-mode #send-button {
            background-color: #333;
            color: #e0e0e0;
        }

        body.dark-mode #send-button:hover {
            background-color: #444;
        }

        body.dark-mode .message-content {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        body.dark-mode #online-users-bar {
            background-color: #1f1f1f;
            border-left: 1px solid #333;
        }

        .message-actions {
            margin-top: 5px;
            display: flex;
            gap: 5px;
        }

        .message-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .react-button {
            background-color: #17a2b8;
            color: white;
        }

        .react-button:hover {
            background-color: #138496;
        }

        .edit-button {
            background-color: #ffc107;
            color: white;
        }

        .edit-button:hover {
            background-color: #e0a800;
        }

        .delete-button {
            background-color: #ff4d4d;
            color: white;
        }

        .delete-button:hover {
            background-color: #e60000;
        }

        .reactions {
            margin-top: 5px;
            font-size: 14px;
            color: #555;
        }

        /* Dark Mode Styles for Rock-Paper-Scissors */
        body.dark-mode #rps-modal {
            background: rgba(0, 0, 0, 0.8);
        }

        body.dark-mode #rps-modal div {
            background: #2a2a2a;
            color: #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            border: 1px solid #555; /* Ensure border matches dark mode */
        }

        body.dark-mode #rps-modal button {
            background-color: #444;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode #rps-modal button:hover {
            background-color: #555;
        }

        body.dark-mode #rps-box {
            background: #2a2a2a;
            color: #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        

        body.dark-mode #rps-box button {
            background-color: #444;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode #rps-box button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="username-modal">
        <form id="username-form">
            <h2>Login or Register</h2>
            <div id="form-tabs" style="display: flex; justify-content: center; margin-bottom: 20px;">
                <button type="button" id="login-tab" style="padding: 10px 20px; border: none; cursor: pointer; background-color: #007BFF; color: white; border-radius: 5px; margin-right: 10px;">Login</button>
                <button type="button" id="register-tab" style="padding: 10px 20px; border: none; cursor: pointer; background-color: #f1f1f1; color: #333; border-radius: 5px;">Register</button>
            </div>
            <div id="login-form" style="display: block;">
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </div>
            <div id="register-form" style="display: none;">
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
            </div>
        </form>
    </div>
    <script>
        const loginTab = document.getElementById('login-tab');
const registerTab = document.getElementById('register-tab');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');

// Switch between login and register forms
loginTab.addEventListener('click', () => {
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
    loginTab.style.backgroundColor = '#007BFF';
    loginTab.style.color = 'white';
    registerTab.style.backgroundColor = '#f1f1f1';
    registerTab.style.color = '#333';
});

registerTab.addEventListener('click', () => {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    registerTab.style.backgroundColor = '#007BFF';
    registerTab.style.color = 'white';
    loginTab.style.backgroundColor = '#f1f1f1';
    loginTab.style.color = '#333';
});

// Handle login form submission
document.querySelector('#login-form button[type="submit"]').addEventListener('click', (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();

    if (!username) {
        alert('Username cannot be empty.');
        return;
    }

    if (username && password) {
        // Emit login event to the server
        socket.emit('login', { username, password });

        // Store the username in localStorage
        localStorage.setItem('username', username);
    } else {
        alert('Please fill in both fields.');
    }
});

// Handle register form submission
document.querySelector('#register-form button[type="submit"]').addEventListener('click', (e) => {
    e.preventDefault();
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value.trim();

    if (!username || !password) {
        alert('Please fill in all fields.');
        return;
    }

    // Emit register event to the server
    socket.emit('register', { username, password });

    // Optionally store the username in localStorage
    localStorage.setItem('username', username);
    alert('Registration successful! Please log in.');
});

// Listen for login success from the server
socket.on('login_success', (data) => {
    alert(data.message);
    const username = data.username; // Get the username from the server response
    localStorage.setItem('username', username); // Store it in localStorage
    joinChat(username); // Call the function to join the chat
});

// Listen for login failure
socket.on('login_failure', (data) => {
    alert(data.message);
});
// Handle register form submission
document.querySelector('#register-form button[type="submit"]').addEventListener('click', (e) => {
    e.preventDefault();
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value.trim();

    if (username && password) {
        socket.emit('register', { username, password });
        console.log(username); // Check if this logs the expected value
        localStorage.setItem('username', username); // Optionally store it in localStorage
        location.reload(); // Refresh the website
        alert("Registered, login.")
    } else {
        alert('Please fill in all fields.');
    }
});


socket.on('login_success', (data) => {
    alert(data.message);
    username = data.username; // Store the username from the server response
    console.log(username); // Check if this logs the expected value
    localStorage.setItem('username', username); // Optionally store it in localStorage
    joinChat(username); // Call the function to join the chat
});

function joinChat(username) {
    document.getElementById('username-modal').style.display = 'none'; // Hide the login modal
    document.getElementById('chat-container').style.display = 'flex'; // Show the chat container
    console.log(username); // Check if this logs the expected value
    localStorage.setItem('username', username); // Optionally store it in localStorage
    socket.emit('join', { username }); // Notify the server that the user has joined
}


socket.on('login_failure', (data) => {
    alert(data.message);
});

// Listen for register success or failure
socket.on('register_success', (data) => {
    alert(data.message);
    username = data.username;
    console.log(username); // Check if this logs the expected value
    localStorage.setItem('username', username); // Optionally store it in localStorage
    joinChat(username);
});

socket.on('register_failure', (data) => {
    alert(data.message);
});
    </script>
    <style>
        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        #username-form {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            animation: scaleUp 0.3s ease-in-out forwards;
        }

        #username-form h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #ffffff;
        }

        #username-form input[type="text"],
        #username-form input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 16px;
            background-color: #1e1e1e;
            color: #ffffff;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #username-form input[type="text"]:focus,
        #username-form input[type="file"]:focus {
            border-color: #007BFF;
        }

        #username-form button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #username-form button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleUp {
            from {
                transform: scale(0.9);
            }
            to {
                transform: scale(1);
            }
        }
    </style>

    <div id="chat-container">

        <div id="top-buttons">
            <button id="logout-button">Logout</button>
            <button id="settings-button">Settings</button>
            <div class="dropdown">
                <button class="dropdown-button">Extras</button>
                <div class="dropdown-content">
                    <button id="game-button">Rock-Paper-Scissors</button>
                    <button id="tictactoe-button">Tic-Tac-Toe</button> <!-- New button -->
                    <button id="superhot-button" onclick="window.location.href='/sh'">SUPERHOT</button>
            <!--    <button id="placeholder-option-2">Placeholder Option 2</button>
                    <button id="placeholder-option-3">Placeholder Option 3</button> -->
                </div>
            </div>
            <style>
                .dropdown {
                    position: relative;
                    display: inline-block;
                }

                .dropdown-button {
                    background-color: #0056b3;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    padding: 20px 15px;
                    cursor: pointer;
                    font-weight: bold;
                    margin-left: 30px;
                }

                .dropdown-button:hover {
                    background-color: #003f7f;
                }

                .dropdown-content {
                    display: none;
                    position: absolute;
                    background-color: #f9f9f900;
                    min-width: 160px;
                    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
                    z-index: 1;
                    border-radius: 5px;
                }

                .dropdown-content button {
                    background-color: white;
                    color: black;
                    border: none;
                    padding: 10px 15px;
                    text-align: left;
                    width: 100%;
                    cursor: pointer;
                }

                .dropdown-content button:hover {
                    background-color: #ddd;
                }

                .dropdown:hover .dropdown-content {
                    display: block;
                }
            </style>
        </div>
        <div id="online-users-bar">
            <h3>Online Users</h3>
            <ul id="online-users-list"></ul>
        </div>
        <!-- Private Message Box -->
        <div id="private-message-box" style="position: fixed; bottom: 10px; right: 10px; width: 300px; background: var(--pm-box-bg, #f1f1f1); border: 1px solid var(--pm-box-border, #ccc); border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: none; z-index: 1000;">
            <div id="private-message-tabs" style="display: flex; border-bottom: 1px solid var(--pm-tabs-border, #ccc); overflow-x: auto;"></div>
            <div id="private-message-content" style="padding: 10px; max-height: 200px; overflow-y: auto; color: var(--pm-content-color, #000);"></div>
            <form id="private-message-form" style="display: flex; padding: 10px; border-top: 1px solid var(--pm-form-border, #ccc);">
            <input type="text" id="private-message-input" placeholder="Type a message..." style="flex: 1; padding: 5px; border: 1px solid var(--pm-input-border, #ccc); border-radius: 5px; margin-right: 5px; background: var(--pm-input-bg, #fff); color: var(--pm-input-color, #000);">
            <button type="submit" style="padding: 5px 10px; background-color: var(--pm-button-bg, #007BFF); color: var(--pm-button-color, white); border: none; border-radius: 5px; cursor: pointer;">Send</button>
            </form>
        </div>
        <style>
            /* Ensure the private message box height adjusts dynamically */
            #private-message-box {
                max-height: 300px; /* Set a maximum height to prevent it from growing indefinitely */
                overflow-y: auto; /* Add a scrollbar if the content exceeds the max height */
                resize: none; /* Prevent resizing by dragging */
            }

            body.dark-mode #private-message-box {
            --pm-box-bg: #2a2a2a;
            --pm-box-border: #444;
            }
            body.dark-mode #private-message-tabs {
            --pm-tabs-border: #555;
            }
            body.dark-mode #private-message-content {
            --pm-content-color: #e0e0e0;
            }
            body.dark-mode #private-message-form {
            --pm-form-border: #555;
            }
            body.dark-mode #private-message-input {
            --pm-input-bg: #1e1e1e;
            --pm-input-border: #555;
            --pm-input-color: #e0e0e0;
            }
            body.dark-mode #private-message-form button {
            --pm-button-bg: #444;
            --pm-button-color: #e0e0e0;
            }
        </style>
        <div id="messages"></div>
        <form id="message-form">
            <button id="gif-button" type="button" style="margin-right: 10px; padding: 10px; background-color: var(--gif-button-bg, #007BFF); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">GIF</button>
            <style>
                body.dark-mode #gif-button {
                    --gif-button-bg: #333;
                }
                #gif-button {
                    --gif-button-bg: #007BFF;
                }
            </style>
            <input type="text" id="message-input" placeholder="Type a message or paste an image..." required>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            <button type="button" id="upload-button" style="margin-right: 10px; padding: 10px 20px; background-color: var(--upload-button-bg, #007BFF); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ðŸ“·</button>
            <style>
                body.dark-mode #upload-button {
                    --upload-button-bg: #333;
                }
                #upload-button {
                    --upload-button-bg: #007BFF;
                }
            </style>
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>
    <div id="gif-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        </div>
        </div>
    <div id="tictactoe-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h2>Tic-Tac-Toe</h2>
                    <div id="tictactoe-board" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 20px auto; width: 150px;">
                        <!-- 3x3 grid for the game -->
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                        <button class="tictactoe-cell" style="width: 50px; height: 50px; font-size: 24px;"></button>
                    </div>
                    <p id="tictactoe-status"></p>
                    <button id="close-tictactoe" style="margin-top: 10px; padding: 10px 20px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
            </div>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        // Handle GIF button click
        const gifButton = document.getElementById('gif-button');
        const gifModal = document.getElementById('gif-modal');

        gifButton.addEventListener('click', () => {
            gifModal.style.display = 'flex';
        });

        // Add GIF search functionality
        gifModal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2>Search GIFs</h2>
            <input type="text" id="gif-search-input" placeholder="Search for GIFs..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <div id="gif-results" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 300px; overflow-y: auto;"></div>
            <button id="close-gif-modal" style="margin-top: 10px; padding: 10px 20px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>
            </div>
        `;

        const gifSearchInput = document.getElementById('gif-search-input');
        const gifResults = document.getElementById('gif-results');
        const closeGifModal = document.getElementById('close-gif-modal');

        gifSearchInput.addEventListener('input', async () => {
            const query = gifSearchInput.value.trim();
            if (query) {
            let response;
            try {
                response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=SzAhImfXJkuLaI0OXFUR7B0hrFo3LLBT&q=${query}&limit=15`);
                if (!response.ok) throw new Error('Primary API key failed');
            } catch (error) {
                console.warn('Primary API key failed, switching to backup key:', error);
                response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=QruKaq2SEEOJVf82Pw5Cj4zDANDdYGDW&q=${query}&limit=15`);
            }
            const data = await response.json();
            gifResults.innerHTML = '';
            data.data.forEach((gif) => {
                const gifImg = document.createElement('img');
                gifImg.src = gif.images.fixed_height.url;
                gifImg.style.cursor = 'pointer';
                gifImg.style.width = '100px';
                gifImg.style.height = '100px';
                gifImg.style.objectFit = 'cover';
                gifImg.addEventListener('click', () => {
                socket.emit('send_message', { username, profilePic, message: '', image: gif.images.fixed_height.url });
                gifModal.style.display = 'none';
                });
                gifResults.appendChild(gifImg);
            });
            }
        });

        closeGifModal.addEventListener('click', () => {
            gifModal.style.display = 'none';
        });
    
        const usernameModal = document.getElementById('username-modal');
        const usernameForm = document.getElementById('username-form');
        const chatContainer = document.getElementById('chat-container');
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const onlineUsersList = document.getElementById('online-users-list');
        const imageUpload = document.getElementById('image-upload');
        const uploadButton = document.getElementById('upload-button');
        const logoutButton = document.getElementById('logout-button');
        const settingsButton = document.getElementById('settings-button');
        const rpsButton = document.getElementById('game-button');


        let username = '';
        let profilePic = '';

        // Load user details from localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load dark mode setting from localStorage
            console.log('Loading dark mode setting from localStorage...');
            const darkModeSetting = localStorage.getItem('dark-mode');
            if (darkModeSetting === 'enabled') {
                document.body.classList.add('dark-mode');
                console.log('Dark mode enabled from localStorage');
            }
            const savedUsername = localStorage.getItem('username');
            if (savedUsername) {
                username = savedUsername;
                socket.emit('join', { username }); // Notify the server that the user has joined
                joinChat(username); // Automatically rejoin the chat
                
            } else {
                document.getElementById('username-modal').style.display = 'flex'; // Show the login modal
            }
            const savedProfilePic = localStorage.getItem('profilePic');

        });

        // Save user details to localStorage on form submission
        usernameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            username = document.getElementById('username').value;
            const fileInput = document.getElementById('profile-pic');

            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    profilePic = reader.result;
                    localStorage.setItem('username', username);
                    localStorage.setItem('profilePic', profilePic);
                    joinChat();
                    
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                profilePic = '';
                localStorage.setItem('username', username);
                localStorage.setItem('profilePic', profilePic);
                joinChat();
            }
        });

        /* Handle username form submission
        usernameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            username = document.getElementById('username').value;
            const fileInput = document.getElementById('profile-pic');
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    profilePic = reader.result;
                    //joinChat();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                profilePic = '';
                //joinChat();
            }
        });
*/
        // Handle page unload or logout
        window.addEventListener('beforeunload', () => {
            socket.emit('leave', { username });
        });

        logoutButton.addEventListener('click', () => {
            socket.emit('leave', { username });
            //location.reload(); // Reload the page to reset the chat
        });

        // Add muted users modal
        const mutedUsersModal = document.createElement('div');
            mutedUsersModal.id = 'muted-users-modal';
            mutedUsersModal.style.position = 'fixed';
            mutedUsersModal.style.bottom = '10px';
            mutedUsersModal.style.right = '20px'; // Adjusted to appear further to the right
            mutedUsersModal.style.background = '#2a2a2a'; // Same color as the online-users box
            mutedUsersModal.style.border = '1px solid #ccc';
            mutedUsersModal.style.padding = '10px';
            mutedUsersModal.style.borderRadius = '5px';
            mutedUsersModal.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            mutedUsersModal.style.zIndex = '1000';
            mutedUsersModal.style.display = 'none'; // Always visible
            mutedUsersModal.innerHTML = `
                <h4>Muted Users</h4>
                <ul id="muted-users-list" style="list-style: none; padding: 0; margin: 0;"></ul>
            `;
        document.body.appendChild(mutedUsersModal);

        // Handle profile picture click
    messagesDiv.addEventListener('click', (e) => {
        if (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('message')) {
        e.stopPropagation(); // Prevent other click events from triggering
        return;

        // Check if a modal is already open
        if (document.getElementById('profile-modal')) {
            return; // Prevent opening multiple modals
        }

        const userProfilePic = e.target;
        const username = userProfilePic.nextElementSibling.querySelector('strong').textContent;

        // Fetch user data
        socket.emit('get_user_data', { username });

        // Create the modal
        const profileModal = document.createElement('div');
        profileModal.id = 'profile-modal'; // Add an ID to prevent duplicates
        profileModal.style.position = 'absolute';
        profileModal.style.border = '1px solid #ccc';
        profileModal.style.padding = '10px';
        profileModal.style.borderRadius = '5px';
        profileModal.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        profileModal.style.zIndex = '1000';
        profileModal.style.background = document.body.classList.contains('dark-mode') ? '#5a5a5a' : '#fff';
        profileModal.style.color = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#000';

        // Add content to the modal
        profileModal.innerHTML = `
            <div>
            <img src="${userProfilePic.src}" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px;">
            <h3>${username}</h3>
            <p id="user-bio" style="margin-bottom: 10px;">Loading bio...</p>
            <button id="mute-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Mute</button>
            <button id="dm-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Direct Message</button>
            <button id="tag-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Tag</button>
            <button id="close-profile-modal" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        `;



        // Position the modal next to the profile picture
        const rect = userProfilePic.getBoundingClientRect();
        profileModal.style.top = `${rect.bottom + window.scrollY}px`;
        profileModal.style.left = `${rect.left + window.scrollX}px`;

        // Close the modal
        document.getElementById('close-profile-modal').addEventListener('click', () => {
            document.body.removeChild(profileModal);
        });

        // Update bio when data is received
        socket.on('user_data', (data) => {
            if (data.bio) {
            document.getElementById('user-bio').textContent = data.bio;
            }
        });

        // Add mute functionality
        document.getElementById('mute-button').addEventListener('click', () => {
            muteUser(username);
            alert(`${username} has been muted.`);
            document.body.removeChild(profileModal);
        });

        // Add direct message functionality
        document.getElementById('dm-button').addEventListener('click', () => {
            openPrivateChat(username);
            document.body.removeChild(profileModal);
        });

        // Add tag functionality
        document.getElementById('tag-button').addEventListener('click', () => {
            messageInput.value += `@${username} `;
            messageInput.focus();
            document.body.removeChild(profileModal);
        });
    

                // Remove their previous messages from the chat
                const userMessages = document.querySelectorAll(`.message strong`);
                userMessages.forEach((message) => {
                    if (message.textContent === username) {
                        message.closest('.message').remove();
                    }
                });

                // Add the user to a muted list
                let mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
                if (!mutedUsers.includes(username)) {
                    mutedUsers.push(username);
                    localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                }

                // Prevent future messages from muted users from being displayed
                socket.on('receive_message', (data) => {
                    if (!mutedUsers.includes(data.username)) {
                        appendMessage(data);
                    }
                });
            

            

            // Function to update the muted users list
            function updateMutedUsersList() {
                alert("The mute function is sort of broken, but basically if it does break (and this goes for anything) just refresh the page.")
                mutedUsersModal.style.display = 'block';
                const mutedUsersList = document.getElementById('muted-users-list');
                mutedUsersList.innerHTML = '';
                const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
                mutedUsers.forEach((mutedUser) => {
                    const userItem = document.createElement('li');
                    userItem.textContent = mutedUser;
                    userItem.style.cursor = 'pointer';
                    userItem.style.color = '#007BFF';
                    userItem.style.marginBottom = '5px';
                    userItem.addEventListener('click', () => {
                        // Unmute the user
                        mutedUsers.splice(mutedUsers.indexOf(mutedUser), 1);
                        localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                        updateMutedUsersList();
                        alert(`${mutedUser} has been unmuted.`);
                    });
                    mutedUsersList.appendChild(userItem);
                });

                

                // Save muted user to localStorage when the user is muted
                socket.on('receive_message', (data) => {
                    const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
                    if (!mutedUsers.includes(data.username)) {
                        appendMessage(data);
                    }
                });

                document.getElementById('mute-button').addEventListener('click', () => {
                    const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
                    if (!mutedUsers.includes(username)) {
                        mutedUsers.push(username);
                        localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                        updateMutedUsersList();
                    }
                });

                


            }

            

            document.getElementById('dm-button').addEventListener('click', () => {
                alert(`Direct messaging ${username}`);
                document.body.removeChild(profileModal);
            });

            document.getElementById('tag-button').addEventListener('click', () => {
                messageInput.value += `@${username} `;
                messageInput.focus();
                document.body.removeChild(profileModal);
            });

            // Close the modal if clicked outside
            const closeModal = (event) => {
    if (profileModal && !profileModal.contains(event.target) && event.target !== userProfilePic) {
        if (document.body.contains(profileModal)) {
            document.body.removeChild(profileModal);
        }
        document.removeEventListener('click', closeModal);
    }
};

            setTimeout(() => {
                document.addEventListener('click', closeModal);
            }, 0); // Delay to prevent immediate closure when clicking the profile picture
            }

            
        });

        function handleMutedUsersOnJoin() {
            try {
            console.log('Fetching muted users from localStorage...');
            const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            console.log('Muted users:', mutedUsers);

            // Prevent future messages from muted users from being displayed
            socket.on('receive_message', (data) => {
                try {
                if (!mutedUsers.includes(data.username)) {
                    appendMessage(data);
                } else {
                    console.log(`Message from muted user ${data.username} ignored.`);
                }
                } catch (error) {
                console.error('Error handling received message:', error);
                }
            });

            // Update the muted users list in the UI
            console.log('Updating muted users list in the UI...');
            const mutedUsersList = document.getElementById('muted-users-list');
            mutedUsersList.innerHTML = '';
            mutedUsers.forEach((mutedUser) => {
                try {
                    console.log(mutedUsers)
                if (mutedUsers == `['']`) {
                    mutedUsersModal.style.display = 'none';
                    return;
                }
                mutedUsersModal.style.display = 'none';
                const userItem = document.createElement('li');
                userItem.textContent = mutedUser;
                userItem.style.cursor = 'pointer';
                userItem.style.color = '#007BFF';
                userItem.style.marginBottom = '5px';
                userItem.addEventListener('click', () => {
                    try {
                    console.log(`Unmuting user: ${mutedUser}`);
                    mutedUsers.splice(mutedUsers.indexOf(mutedUser), 1);
                    localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                    handleMutedUsersOnJoin();
                    alert(`${mutedUser} has been unmuted.`);
                    } catch (error) {
                    console.error('Error unmuting user:', error);
                    }
                });
                mutedUsersList.appendChild(userItem);
                } catch (error) {
                console.error('Error updating muted users list item:', error);
                }
            });

            console.log('Removing previous messages from muted users...');
                mutedUsers.forEach((mutedUser) => {
                    try {
                        const userMessages = document.querySelectorAll(`.message-content strong`);
                        userMessages.forEach((message) => {
                            if (message.textContent === mutedUser) {
                                const messageElement = message.closest('.message');
                                if (messageElement) {
                                    messageElement.remove();
                                    console.log(`Removed message from muted user: ${mutedUser}`);
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error removing messages from muted user:', error);
                    }
                });
            } catch (error) {
                console.error('Error in handleMutedUsersOnJoin: An unexpected error occurred.', error);
            }
        }

        function joinChat(username) {
            usernameModal.style.display = 'none';
            chatContainer.style.display = 'flex';
            socket.emit('join', { username, profilePic });
            console.log(`updating muted users.`);
            handleMutedUsersOnJoin();
            
        }

        // Temporary storage for muted users' messages
        const mutedMessages = (() => {
            try {
                const data = localStorage.getItem('mutedMessages');
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error('Error parsing mutedMessages from localStorage:', error);
                localStorage.removeItem('mutedMessages'); // Clear corrupted data
                return {}; // Return an empty object as fallback
            }
        })();

        // Ensure this is registered only once, at the top level of your script
        if (!window.loadMessagesListenerRegistered) {
            console.log('Registering load_messages listener');
            socket.off('load_messages'); // Remove any existing listeners
            socket.on('load_messages', (messages) => {
                console.log('load_messages event received');
                const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
                messagesDiv.innerHTML = ''; // Clear the messages div to avoid duplicates
                messages.forEach((message) => {
                    if (!mutedUsers.includes(message.username)) {
                        appendMessage(message);
                    }
                });
            });
            window.loadMessagesListenerRegistered = true; // Mark the listener as registered
        }

        // Function to mute a user
        function muteUser(username) {
            /*let mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            if (!mutedUsers.includes(username)) {
                mutedUsers.push(username);
                localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                updateMutedUsersList();
                */
            alert("Mute functionality has been disabled.");
            }

            // Remove their messages from the chat
            const userMessages = document.querySelectorAll(`.message-content strong`);
            userMessages.forEach((message) => {
                if (message.textContent === username) {
                    const messageElement = message.closest('.message');
                    if (messageElement) {
                        // Store the message persistently
                        if (!mutedMessages[username]) mutedMessages[username] = [];
                        mutedMessages[username].push({
                            id: messageElement.dataset.id,
                            username,
                            profilePic: messageElement.querySelector('img').src,
                            message: messageElement.querySelector('p').textContent,
                            reactions: messageElement.querySelector('.reactions').textContent,
                        });
                        messageElement.remove();
                    }
                }
            });
            localStorage.setItem('mutedMessages', JSON.stringify(mutedMessages)); // Save muted messages
        

        // Function to unmute a user
        function unmuteUser(username) {
            let mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            mutedUsers = mutedUsers.filter((user) => user !== username);
            localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
            updateMutedUsersList();

            // Bring back their messages
            if (mutedMessages[username]) {
                mutedMessages[username].forEach((message) => appendMessage(message));
                delete mutedMessages[username]; // Clear stored messages for the user
                localStorage.setItem('mutedMessages', JSON.stringify(mutedMessages)); // Update storage
            }
        }

        // Function to update the muted users list
        function updateMutedUsersList() {
            const mutedUsersList = document.getElementById('muted-users-list');
            mutedUsersList.innerHTML = '';
            const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            mutedUsers.forEach((mutedUser) => {
                const userItem = document.createElement('li');
                userItem.textContent = mutedUser;
                userItem.style.cursor = 'pointer';
                userItem.style.color = '#007BFF';
                userItem.style.marginBottom = '5px';
                userItem.addEventListener('click', () => {
                    unmuteUser(mutedUser);
                    //alert(`${mutedUser} has been unmuted.`);
                });
                mutedUsersList.appendChild(userItem);
            });
        }

        // Handle profile picture click
messagesDiv.addEventListener('click', (e) => {
    if (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('message')) {
        e.stopPropagation(); // Prevent other click events from triggering
        const userProfilePic = e.target;
        const username = userProfilePic.nextElementSibling.querySelector('strong').textContent;

        // Fetch user data
        socket.emit('get_user_data', { username });

        // Create the modal
        const profileModal = document.createElement('div');
        profileModal.style.position = 'absolute';
        profileModal.style.background = '#fff';
        profileModal.style.border = '1px solid #ccc';
        profileModal.style.padding = '10px';
        profileModal.style.borderRadius = '5px';
        profileModal.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        profileModal.style.zIndex = '1000';

        // Add content to the modal
        profileModal.innerHTML = `
            <img src="${userProfilePic.src}" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px;">
            <h3>${username}</h3>
            <p id="user-bio" style="margin-bottom: 10px;">Loading bio...</p>
            <button id="mute-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Mute</button>
            <button id="dm-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Direct Message</button>
            <button id="tag-button" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Tag</button>
            <button id="close-profile-modal" style="margin-top: 10px; padding: 5px 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        `;

        document.body.appendChild(profileModal);

        // Position the modal next to the profile picture
        const rect = userProfilePic.getBoundingClientRect();
        profileModal.style.top = `${rect.bottom + window.scrollY}px`;
        profileModal.style.left = `${rect.left + window.scrollX}px`;

        // Close the modal
        document.getElementById('close-profile-modal').addEventListener('click', () => {
            document.body.removeChild(profileModal);
        });

        // Update bio when data is received
        socket.on('user_data', (data) => {
            if (data.bio) {
                document.getElementById('user-bio').textContent = data.bio;
            }
        });

        // Add mute functionality
        document.getElementById('mute-button').addEventListener('click', () => {
            muteUser(username);
            //alert(`${username} has been muted.`);
            document.body.removeChild(profileModal);
        });

        // Add direct message functionality
        document.getElementById('dm-button').addEventListener('click', () => {
            openPrivateChat(username);
            document.body.removeChild(profileModal);
        });

        // Add tag functionality
        document.getElementById('tag-button').addEventListener('click', () => {
            messageInput.value += `@${username} `;
            messageInput.focus();
            document.body.removeChild(profileModal);
        });

        // Close the modal if clicked outside
        const closeModal = (event) => {
            if (!profileModal.contains(event.target) && event.target !== userProfilePic) {
                document.body.removeChild(profileModal);
                document.removeEventListener('click', closeModal);
            }
        };

        setTimeout(() => {
            document.addEventListener('click', closeModal);
        }, 0); // Delay to prevent immediate closure when clicking the profile picture
    }
});

        /* Load old messages when the page loads
        socket.on('load_messages', (messages) => {
            const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            messages.forEach((message) => {
                if (mutedUsers.includes(message.username)) {
                    // Store muted messages persistently
                    if (!mutedMessages[message.username]) mutedMessages[message.username] = [];
                    mutedMessages[message.username].push(message);
                } else {
                    appendMessage(message);
                }
            });
            localStorage.setItem('mutedMessages', JSON.stringify(mutedMessages)); // Save muted messages
        }); */

        // Function to update the muted users list
        function updateMutedUsersList() {
            const mutedUsersList = document.getElementById('muted-users-list');
            mutedUsersList.innerHTML = '';
            const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            mutedUsers.forEach((mutedUser) => {
                const userItem = document.createElement('li');
                userItem.textContent = mutedUser;
                userItem.style.cursor = 'pointer';
                userItem.style.color = '#007BFF';
                userItem.style.marginBottom = '5px';
                userItem.addEventListener('click', () => {
                    // Unmute the user
                    mutedUsers.splice(mutedUsers.indexOf(mutedUser), 1);
                    localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
                    updateMutedUsersList();
                    alert(
                        "Warning: Unmuting this user may cause messages to reappear broken. Refresh the page to fix any issues."
                    );
                    //alert(`${mutedUser} has been unmuted.`);

                    // Bring back their messages
                    if (mutedMessages[mutedUser]) {
                        mutedMessages[mutedUser].forEach((message) => appendMessage(message));
                        delete mutedMessages[mutedUser]; // Clear stored messages for the user
                    }
                });
                mutedUsersList.appendChild(userItem);
            });
        }

        // Listen for admin broadcast alerts
        socket.on('receive_alert', (data) => {
            const alertMessage = data.alert || 'Broadcast Alert';
            alert("Admin Alert: "+alertMessage); // Display the alert message to the user
        });

        /* Load old messages when the page loads
        socket.on('load_messages', (messages) => {
            const mutedUsers = JSON.parse(localStorage.getItem('mutedUsers')) || [];
            messages
                .filter((message) => !mutedUsers.includes(message.username)) // Exclude messages from muted users
                .forEach((message) => appendMessage(message));
        }); */

        // Handle sending a message
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', { username, profilePic, message });
                messageInput.value = ''; // Clear the input field
            }
        });


        // Fetch all messages from the database on login
        socket.on('login_success', (username) => {
            console.log("loading messages on login")
            console.log(username)
            
            socket.emit('join', { username }); // Notify the server that the user has joined
            location.reload()
            joinChat(username); // Automatically rejoin the chat
            socket.emit('load_messages', {}, (messages) => {
                messages.forEach(message => appendMessage(message));
            });
        });

        // Append a message to the chat
        function appendMessage({ id, username: messageUsername, profilePic, message, image, reactions }) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.dataset.id = id;

            const imageTag = image
                ? `<img src="${image}" alt="Uploaded Image" style="width: 400px; height: auto; margin-top: 10px; border-radius: 0; border: none;">`
                : '';

            const isOwnMessage = messageUsername === username;

            messageElement.innerHTML = `
                <img src="${profilePic || 'https://media.tenor.com/fnVo42SgddYAAAAM/dog.gif'}" alt="Profile Picture">
                <div class="message-content">
                    <strong>${messageUsername}</strong>
                    <p>${message}</p>
                    ${imageTag}
                <div class="reactions">${Array.isArray(reactions) ? reactions.join(' ') : reactions || ''}</div>
                    <div class="message-actions">
                        <button class="react-button" data-message-id="${id}">React</button>
                        ${isOwnMessage ? `<button class="edit-button" data-message-id="${id}">Edit</button>` : ''}
                        ${isOwnMessage ? `<button class="delete-button" data-message-id="${id}">Delete</button>` : ''}
                    </div>
                </div>
            `;

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            // Highlight the message if it contains a tag for the current user
            if (message.includes(`@${username}`)) {
                const messageElement = messagesDiv.querySelector(`.message[data-id="${id}"]`);
                if (messageElement) {
                    const messageBox = messageElement.querySelector('.message-content');
                    if (messageBox) {
                        messageBox.style.boxShadow = '0 0 10px 2px #ffeb3b'; // Add a glowing yellow highlight
                        messageBox.style.transition = 'box-shadow 0.3s ease-in-out'; // Smooth transition
                    }
                    setTimeout(() => {
                        messageBox.style.transition = 'box-shadow 0.4s ease-in-out'; // Smooth transition
                        messageBox.style.boxShadow = ''; // Remove highlight after 6 seconds
                    }, 6000);
                }
            }
        }

       // Handle reaction button click
        messagesDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('react-button')) {
        const messageId = e.target.dataset.messageId;
        const emojiPicker = document.createElement('div');
        emojiPicker.style.position = 'absolute';
        emojiPicker.style.background = '#fff';
        emojiPicker.style.border = '1px solid #ccc';
        emojiPicker.style.padding = '10px';
        emojiPicker.style.borderRadius = '5px';
        emojiPicker.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        emojiPicker.style.zIndex = '1000';

        const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ‘', 'ðŸŽ‰', 'â¤ï¸', 'ðŸ˜¢', 'ðŸ˜¡'];
        emojis.forEach((emoji) => {
            const emojiButton = document.createElement('button');
            emojiButton.textContent = emoji;
            emojiButton.style.border = 'none';
            emojiButton.style.background = 'transparent';
            emojiButton.style.fontSize = '20px';
            emojiButton.style.cursor = 'pointer';
            emojiButton.style.margin = '5px';
            emojiButton.addEventListener('click', () => {
                socket.emit('add_reaction', { id: messageId, reaction: emoji });
                document.body.removeChild(emojiPicker);
            });
            emojiPicker.appendChild(emojiButton);
        });

        document.body.appendChild(emojiPicker);

        // Position the emoji picker near the clicked button
        const rect = e.target.getBoundingClientRect();
        emojiPicker.style.top = `${rect.bottom + window.scrollY}px`;
        emojiPicker.style.left = `${rect.left + window.scrollX}px`;

        // Close the emoji picker if clicked outside
        document.addEventListener('click', (event) => {
            if (!emojiPicker.contains(event.target) && event.target !== e.target) {
                document.body.removeChild(emojiPicker);
            }
        }, { once: true });
    }
});

        // Handle edit button click
        messagesDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-button')) {
                const messageId = e.target.dataset.messageId;
                const currentMessage = e.target.closest('.message').querySelector('p').textContent;
                const newMessage = prompt('Edit your message:', currentMessage);
                if (newMessage !== null) {
                    socket.emit('edit_message', { id: messageId, message: newMessage });
                }
            }
        });

        // Handle delete button click
        messagesDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-button')) {
                const messageId = e.target.dataset.messageId;
                if (confirm('Are you sure you want to delete this message?')) {
                    socket.emit('delete_message', { id: messageId });
                }
            }
        });

        // Update reactions for a message in real-time
    socket.on('update_reactions', (data) => {
    console.log(`Received update_reactions event for message ID: ${data.id}, reactions: ${data.reactions}`);
    
    // Find the message element by its data-id
    const messageElement = document.querySelector(`.message[data-id="${data.id}"]`);
    if (messageElement) {
        console.log(`Message element found for ID: ${data.id}`);
        
        // Find the reactions div inside the message element
        const reactionsDiv = messageElement.querySelector('.reactions');
        if (reactionsDiv) {
            console.log(`Reactions div found for message ID: ${data.id}`);
            
            // Update the reactions div with the new reactions
            reactionsDiv.innerHTML = data.reactions || ''; // Use innerHTML to handle emojis properly
            console.log(`Reactions updated for message ID: ${data.id}, reactions: ${data.reactions}`);
        } else {
            console.error(`Reactions div not found for message ID: ${data.id}`);
        }
    } else {
        console.error(`Message element not found for message ID: ${data.id}`);
    }
});

        

// Listen for the server response with the list of users (register only once)
socket.on('reaction_users', (data) => {
    try {
        console.log(`Received reaction users for message ID: ${data.id}`);
        const reactionModal = document.createElement('div');
        reactionModal.style.position = 'fixed';
        reactionModal.style.top = '0';
        reactionModal.style.left = '0';
        reactionModal.style.width = '100%';
        reactionModal.style.height = '100%';
        reactionModal.style.background = 'rgba(0, 0, 0, 0.5)';
        reactionModal.style.display = 'flex';
        reactionModal.style.justifyContent = 'center';
        reactionModal.style.alignItems = 'center';
        if (document.body.classList.contains('dark-mode')) {
            reactionModal.style.background = 'rgba(0, 0, 0, 0.8)';
            const reactionContent = reactionModal.querySelector('div');
            if (reactionContent) {
                reactionContent.style.background = '#2a2a2a';
                reactionContent.style.color = '#e0e0e0';
                reactionContent.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.5)';
            }
        }

        const reactionDetails = data.reaction_details;
        const reactionList = Object.entries(reactionDetails)
            .map(([emoji, users]) => `
                <li>
                    <strong>${emoji}</strong>: ${users.join(', ')}
                </li>
            `)
            .join('');

        reactionModal.innerHTML = `
            <div style="background: ${document.body.classList.contains('dark-mode') ? '#2a2a2a' : 'white'}; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <h2 style="color: ${document.body.classList.contains('dark-mode') ? '#e0e0e0' : 'black'};">Reactions for Message</h2>
                <ul style="list-style: none; padding: 0; color: ${document.body.classList.contains('dark-mode') ? '#e0e0e0' : 'black'};">
                    ${reactionList}
                </ul>
                <button id="close-reaction-modal" style="margin-top: 10px; padding: 10px 20px; background-color: ${document.body.classList.contains('dark-mode') ? '#444' : '#444'}; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>
            </div>
        `;
        document.body.appendChild(reactionModal);

        document.getElementById('close-reaction-modal').addEventListener('click', () => {
            document.body.removeChild(reactionModal);
        });
    } catch (error) {
        console.error("Error processing reaction users response:", error);
    }
});

        // Update a message after editing
        socket.on('update_message', (data) => {
            const messageElement = document.querySelector(`.message[data-id="${data.id}"]`);
            if (messageElement) {
                const messageContent = messageElement.querySelector('p');
                messageContent.textContent = data.message;
            }
        });

        // Remove a message after deletion
        socket.on('remove_message', (data) => {
            const messageElement = document.querySelector(`.message[data-id="${data.id}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        });

        // Listen for the admin chat erased event
        socket.on('admin_chat_erased', () => {
            // Clear the messages div
            messagesDiv.innerHTML = '';

            // Notify the user that the chat has been erased
            alert('The chat has been erased by an admin.');
        });

        

        // Mark user as online after login
        socket.on('connect', () => {
            socket.emit('mark_online', { username });
        });

        // Mark user as offline on disconnect
        socket.on('disconnect', () => {
            socket.emit('mark_offline', { username });
        });

        socket.on('user_stopped_typing', (data) => {
            const userItem = document.querySelector(`#online-users-list li[data-username="${data.username}"]`);
            if (userItem) {
                userItem.textContent = data.username;
            }
        });

        // Update the online users list
        socket.on('update_online_users', (users) => {
            onlineUsersList.innerHTML = '';
            users.forEach((user) => {
                const userItem = document.createElement('li');
                userItem.textContent = user.username;
                if (user.isTyping) {
                    userItem.textContent += ' - typing...';
                }
                onlineUsersList.appendChild(userItem);
            });
        });

        // Handle typing indicator
        let typingTimeout;
        messageInput.addEventListener('input', () => {
            socket.emit('typing', { username });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop_typing', { username });
            }, 2000);
        });

        // Emit start-typing event when user starts typing
        messageInput.addEventListener('keydown', () => {
            if (event.key === 'Enter') return;
            socket.emit('start_typing', { username });
        });

        // Emit stop-typing event when user stops typing
        messageInput.addEventListener('keyup', () => {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop_typing', { username });
            }, 2000);
        });

        // Handle image upload button click
        uploadButton.addEventListener('click', () => {
            imageUpload.click(); // Trigger the hidden file input
        });

        // Handle image file selection
        imageUpload.addEventListener('change', () => {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const imageData = reader.result;
                    socket.emit('send_message', { username, profilePic, message: '', image: imageData });
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle pasting an image into the text box
        messageInput.addEventListener('paste', (event) => {
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                    const file = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = () => {
                        const imageData = reader.result;
                        socket.emit('send_message', { username, profilePic, message: '', image: imageData });
                    };
                    reader.readAsDataURL(file);
                    event.preventDefault(); // Prevent the default paste behavior
                    break;
                }
            }
        });



        // Handle logout button click
        logoutButton.addEventListener('click', () => {
            socket.emit('logout', { username });
            //location.reload(); // Reload the page to reset the chat
            usernameModal.style.display = 'flex';
            chatContainer.style.display = 'none';
            localStorage.removeItem('username');
            localStorage.removeItem('profilePic');
        });

        document.getElementById('logout-button').addEventListener('click', () => {
        socket.emit('leave', { username }); // Notify the server
        localStorage.removeItem('username'); // Clear the username from localStorage
        location.reload(); // Reload the page to reset the app
    });

        rpsButton.addEventListener('click', () => {
                const rpsModal = document.createElement('div');
                rpsModal.id = 'rps-modal';
                rpsModal.style.position = 'fixed';
                rpsModal.style.top = '0';
                rpsModal.style.left = '0';
                rpsModal.style.width = '100%';
                rpsModal.style.height = '100%';
                rpsModal.style.background = 'rgba(0, 0, 0, 0.5)';
                rpsModal.style.display = 'flex';
                rpsModal.style.justifyContent = 'center';
                rpsModal.style.alignItems = 'center';
                rpsModal.innerHTML = `
                <div id="rps-box" style="padding: 20px; border-radius: 5px; text-align: center; background: var(--rps-background, #ffffff); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h2>Rock Paper Scissors</h2>
                    <p></p>
                    <div id="rps-options" style="display: none;">
                        <button class="rps-choice" data-choice="rock">Rock</button>
                        <button class="rps-choice" data-choice="paper">Paper</button>
                        <button class="rps-choice" data-choice="scissors">Scissors</button>
                    </div>
                    <p id="rps-result"></p>
                    <button id="close-rps">Close</button>
                </div>
                <style>
                    body.dark-mode #rps-box {
                        --rps-background: #2a2a2a;
                    }
                    #rps-box {
                        --rps-background: #ffffff;
                    }
                </style>
                `;
                document.body.appendChild(rpsModal);

                const rpsOptions = document.getElementById('rps-options');
                const rpsResult = document.getElementById('rps-result');

                socket.emit('join_rps', { username });
                console.log('Joining Rock-Paper-Scissors game...');

                socket.on('rps_start', (data) => {
                    rpsOptions.style.display = 'block';
                    rpsResult.textContent = `Opponent: ${data.opponent}. Make your choice!`;
                });

                document.querySelectorAll('.rps-choice').forEach((button) => {
                    button.addEventListener('click', () => {
                        const choice = button.dataset.choice;
                        socket.emit('rps_choice', { username, choice });
                        rpsResult.textContent = 'Waiting for the other player...';
                        rpsOptions.style.display = 'none';
                    });
                });

                socket.on('rps_result', (data) => {
                    rpsResult.textContent = data.result;
                });

                document.getElementById('close-rps').addEventListener('click', () => {
                    socket.emit('leave_rps', { username });
                    document.body.removeChild(rpsModal);
                });
            });

        const tictactoeButton = document.getElementById('tictactoe-button');
        const tictactoeModal = document.getElementById('tictactoe-modal');
        const tictactoeBoard = document.getElementById('tictactoe-board');
        const tictactoeStatus = document.getElementById('tictactoe-status');
        const closeTicTacToe = document.getElementById('close-tictactoe');

        let tictactoeGame = {
            board: ['', '', '', '', '', '', '', '', ''],
            currentPlayer: 'X',
            isGameOver: false,
            opponent: null,
        };

        // Open the Tic-Tac-Toe modal
        tictactoeButton.addEventListener('click', () => {
            console.log("Requesting to join Tic-Tac-Toe game...");
            socket.emit('join_tictactoe', { username });
        });

        // Close the Tic-Tac-Toe modal
        closeTicTacToe.addEventListener('click', () => {
            tictactoeModal.style.display = 'none';
            socket.emit('leave_tictactoe', { username });
        });

        // Reset the game
        function resetTicTacToe() {
            tictactoeGame.board = ['', '', '', '', '', '', '', '', ''];
            tictactoeGame.currentPlayer = 'X';
            tictactoeGame.isGameOver = false;
            tictactoeStatus.textContent = '';
            Array.from(tictactoeBoard.children).forEach((cell, index) => {
            cell.textContent = '';
            cell.removeEventListener('click', handleCellClick);
            cell.addEventListener('click', () => makeMove(index));
            });
        }

        // Handle a player's move
        function makeMove(index) {
            if (tictactoeGame.isGameOver || tictactoeGame.board[index] !== '' || tictactoeGame.currentPlayer !== 'X') return;

            tictactoeGame.board[index] = 'X';
            tictactoeBoard.children[index].textContent = 'X';
            socket.emit('tictactoe_move', { index, player: 'X' });

            if (checkWinner()) {
            tictactoeStatus.textContent = `You win!`;
            tictactoeGame.isGameOver = true;
            socket.emit('tictactoe_game_over', { winner: username });
            } else if (tictactoeGame.board.every(cell => cell !== '')) {
            tictactoeStatus.textContent = "It's a tie!";
            tictactoeGame.isGameOver = true;
            socket.emit('tictactoe_game_over', { winner: null });
            } else {
            tictactoeGame.currentPlayer = 'O';
            tictactoeStatus.textContent = "Waiting for opponent's move...";
            }
        }

        // Check for a winner
        function checkWinner() {
            const winningCombinations = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
            [0, 4, 8], [2, 4, 6],           // Diagonals
            ];

            return winningCombinations.some(combination => {
            const [a, b, c] = combination;
            return (
                tictactoeGame.board[a] &&
                tictactoeGame.board[a] === tictactoeGame.board[b] &&
                tictactoeGame.board[a] === tictactoeGame.board[c]
            );
            });
        }

        // Handle opponent's move
        socket.on('tictactoe_move', (data) => {
            if (data.player === 'O') {
            tictactoeGame.board[data.index] = 'O';
            tictactoeBoard.children[data.index].textContent = 'O';

            if (checkWinner()) {
                tictactoeStatus.textContent = `Opponent wins!`;
                tictactoeGame.isGameOver = true;
            } else if (tictactoeGame.board.every(cell => cell !== '')) {
                tictactoeStatus.textContent = "It's a tie!";
                tictactoeGame.isGameOver = true;
            } else {
                tictactoeGame.currentPlayer = 'X';
                tictactoeStatus.textContent = "Your turn!";
            }
            }
        });

        // Handle game start
        socket.on('tictactoe_start', (data) => {
            tictactoeGame.opponent = data.opponent;
            tictactoeModal.style.display = 'flex';
            resetTicTacToe();
            tictactoeStatus.textContent = data.isFirstPlayer ? "Your turn!" : "Waiting for opponent's move...";
            tictactoeGame.currentPlayer = data.isFirstPlayer ? 'X' : 'O';
        });

        // Handle game over
        socket.on('tictactoe_game_over', (data) => {
            if (data.winner) {
            tictactoeStatus.textContent = data.winner === username ? "You win!" : "Opponent wins!";
            } else {
            tictactoeStatus.textContent = "It's a tie!";
            }
            tictactoeGame.isGameOver = true;
        });

        // Handle opponent leaving
        socket.on('tictactoe_opponent_left', () => {
            tictactoeStatus.textContent = "Opponent left the game.";
            tictactoeGame.isGameOver = true;
        });
        settingsButton.addEventListener('click', () => {
            const settingsModal = document.createElement('div');
            settingsModal.id = 'settings-modal';
            settingsModal.style.position = 'fixed';
            settingsModal.style.top = '0';
            settingsModal.style.left = '0';
            settingsModal.style.width = '100%';
            settingsModal.style.height = '100%';
            settingsModal.style.background = 'rgba(0, 0, 0, 0.5)';
            settingsModal.style.display = 'flex';
            settingsModal.style.justifyContent = 'center';
            settingsModal.style.alignItems = 'center';
            settingsModal.innerHTML = `
            <div style="padding: 20px; border-radius: 5px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <h2>Settings</h2>
                <label>
                <input type="checkbox" id="dark-mode-toggle">
                Enable Dark Mode
                </label>
                <br><br>
                <label>
            <strong>Bio:</strong>
            <textarea id="bio-input" placeholder="Write something about yourself..." style="width: 100%; height: 60px; margin-bottom: 10px;"></textarea>
        </label>
        <label>
            <strong>Profile Picture:</strong>
            <input type="file" id="profile-pic-input" accept="image/*" style="margin-bottom: 10px;">
        </label>
        <button id="save-settings" style="margin-top: 10px; padding: 10px 20px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
                <button id="close-settings">Close</button>
            </div>
            `;
            document.body.appendChild(settingsModal);

            const darkModeToggle = document.getElementById('dark-mode-toggle');
            darkModeToggle.checked = document.body.classList.contains('dark-mode');

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            });

const bioInput = document.getElementById('bio-input');
const profilePicInput = document.getElementById('profile-pic-input');
const saveSettingsButton = document.getElementById('save-settings');
const closeSettingsButton = document.getElementById('close-settings');

// Open settings modal
settingsButton.addEventListener('click', () => {
    settingsModal.style.display = 'flex';

    // Load current bio and profile picture
    socket.emit('get_user_data', { username });
});

// Close settings modal
closeSettingsButton.addEventListener('click', () => {
    settingsModal.style.display = 'none';
});

// Save bio and profile picture
saveSettingsButton.addEventListener('click', () => {
    const bio = bioInput.value.trim();
    const profilePicFile = profilePicInput.files[0];

    if (profilePicFile) {
        const reader = new FileReader();
        reader.onload = () => {
            const profilePic = reader.result; // Base64 image
            socket.emit('update_user_data', { username, bio, profilePic });
        };
        reader.readAsDataURL(profilePicFile);
    } else {
        socket.emit('update_user_data', { username, bio });
    }

    alert('Settings updated!');
    settingsModal.style.display = 'none';
});

// Listen for user data
socket.on('user_data', (data) => {
    bioInput.value = data.bio || '';
    // Optionally, display the current profile picture
});

            // Add the event listener directly to messagesDiv
            messagesDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('message-content')) {
                    console.log('Image clicked:', e.target.src);
                    const imageUrl = e.target.src;
                    window.open(imageUrl, '_blank');
                }
            });

            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    clearTimeout(typingTimeout);
                    socket.emit('stop_typing', { username });
                }
            });



            // Save dark mode setting to localStorage
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('dark-mode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('dark-mode', 'disabled');
                }
            });

            document.getElementById('close-settings').addEventListener('click', () => {
            document.body.removeChild(settingsModal);
            });
        });

        
// Private Messaging Variables
const privateMessageBox = document.getElementById('private-message-box');
const privateMessageTabs = document.getElementById('private-message-tabs');
const privateMessageContent = document.getElementById('private-message-content');
const privateMessageForm = document.getElementById('private-message-form');
const privateMessageInput = document.getElementById('private-message-input');

let privateChats = {}; // Store private chats in memory

// Handle Private Message Button Click
document.body.addEventListener('click', (e) => {
    if (e.target.id === 'dm-button') {
        const messageElement = e.target.closest('.message');
        if (messageElement) {
            const recipient = messageElement.querySelector('strong').textContent;
            openPrivateChat(recipient);
        } else {
            console.error('Could not find the parent .message element for the DM button.');
        }
    }
});

// Make the private message box draggable
privateMessageBox.style.position = 'absolute';
privateMessageBox.style.cursor = 'move';

let isDragging = false;
let offsetX, offsetY;

privateMessageBox.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - privateMessageBox.offsetLeft;
    offsetY = e.clientY - privateMessageBox.offsetTop;
    privateMessageBox.style.transition = 'none'; // Disable transition during drag
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        privateMessageBox.style.left = `${e.clientX - offsetX}px`;
        privateMessageBox.style.top = `${e.clientY - offsetY}px`;
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
    privateMessageBox.style.transition = ''; // Re-enable transition after drag
});

// Open a Private Chat Tab
function openPrivateChat(username) {
    if (!privateChats[username]) {
        privateChats[username] = []; // Initialize chat history

        // Create a new tab for the user
        const tab = document.createElement('div');
        tab.textContent = username;
        tab.style.padding = '5px 10px';
        tab.style.cursor = 'pointer';
        tab.style.borderBottom = '2px solid transparent';
        tab.style.marginRight = '5px';
        tab.addEventListener('click', () => switchPrivateChat(username));
        privateMessageTabs.appendChild(tab);

        // Automatically switch to the new tab
        switchPrivateChat(username);
    }

    // Show the private message box
    privateMessageBox.style.display = 'block';
}

// Switch to a Private Chat Tab
function switchPrivateChat(username) {
    // Highlight the active tab
    Array.from(privateMessageTabs.children).forEach((tab) => {
        tab.style.borderBottom = tab.textContent === username ? '2px solid #007BFF' : '2px solid transparent';
    });

    // Display the chat history
    privateMessageContent.innerHTML = '';
    privateChats[username].forEach((message) => {
        const messageElement = document.createElement('div');
        messageElement.textContent = message;
        privateMessageContent.appendChild(messageElement);
    });

    // Save the current chat recipient
    privateMessageBox.dataset.activeChat = username;
}

// Function to adjust the height of the private message box based on its content
function adjustPrivateMessageBoxHeight() {
    const contentHeight = privateMessageContent.scrollHeight;
    privateMessageBox.style.height = `${contentHeight + 50}px`; // Add padding for input and margins
}

// Handle Sending a Private Message
privateMessageForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = privateMessageInput.value.trim();
    const recipient = privateMessageBox.dataset.activeChat;

    if (message && recipient) {
        // Append the message to the chat history
        privateChats[recipient].push(`You: ${message}`);
        switchPrivateChat(recipient);

        // Emit the private message to the server
        socket.emit('private_message', { username, recipient, message });

        // Clear the input field
        privateMessageInput.value = '';

        // Adjust the height of the private message box
        adjustPrivateMessageBoxHeight();
    }
});

// Adjust the height when receiving a private message
socket.on('receive_private_message', (data) => {
    const { sender, message } = data;

    // Open a private chat tab if it doesn't exist
    if (!privateChats[sender]) {
        openPrivateChat(sender); // Create the tab and initialize the chat
    }

    // Append the message to the chat history
    privateChats[sender].push(`${sender}: ${message}`);

    // If the chat is active, display the new message
    if (privateMessageBox.dataset.activeChat === sender) {
        switchPrivateChat(sender);
    }

    // Adjust the height of the private message box
    adjustPrivateMessageBoxHeight();
});

// Request notification permission on page load
if (Notification && Notification.permission !== "granted") {
    Notification.requestPermission();
}

// Function to send a desktop notification
function sendNotification(title, body, icon) {
    if (Notification && Notification.permission === "granted") {
        new Notification(title, { body, icon });
    }
}

// Handle receiving a message
socket.on('receive_message', (data) => {

    // Send a desktop notification for the received message
    if (data.username !== username) { // Avoid notifying for own messages
        sendNotification(
            `${data.username} sent a message`,
            data.message || "You have a new message!",
            data.profilePic || 'https://media.tenor.com/fnVo42SgddYAAAAM/dog.gif'
        );
    }
});

// Request notification permission on page load
window.addEventListener('load', () => {
    if (Notification && Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notification permission granted.");
            } else {
                console.log("Notification permission denied.");
            }
        });
    }
});

/// Handle Receiving a Private Message
socket.on('receive_private_message', (data) => {
    const { sender, message } = data;
    console.log(`Private message received from ${sender}: ${message}`);

    // Open a private chat tab if it doesn't exist
    if (!privateChats[sender]) {
        openPrivateChat(sender); // Create the tab and initialize the chat
    }

    // Append the message to the chat history
    privateChats[sender].push(`${sender}: ${message}`);

    // If the chat is active, display the new message
    if (privateMessageBox.dataset.activeChat === sender) {
        switchPrivateChat(sender);
    } else {
        // Highlight the tab if the chat is not active
        const tab = Array.from(privateMessageTabs.children).find(tab => tab.textContent === sender);
        if (tab) {
            tab.style.backgroundColor = '#f0f0f0'; // Highlight the tab
        }
    }

    // Ensure the private message box is visible
    privateMessageBox.style.display = 'block';
});
// Highlight the tab if the chat is not active
const tab = Array.from(privateMessageTabs.children).find(tab => tab.textContent === sender);
if (tab) {
    tab.style.backgroundColor = '#f0f0f0'; // Highlight the tab
    if (!tab.querySelector('.unread-badge')) {
        const badge = document.createElement('span');
        badge.classList.add('unread-badge');
        badge.style.backgroundColor = 'red';
        badge.style.width = '10px';
        badge.style.height = '10px';
        badge.style.borderRadius = '50%';
        badge.style.display = 'inline-block';
        badge.style.marginLeft = '5px';
        tab.appendChild(badge);
    }
    } else {
        const badge = tab.querySelector('.unread-badge');
        badge.textContent = parseInt(badge.textContent) + 1; // Increment unread count
    }


        
        
    </script>
</body>
</html>